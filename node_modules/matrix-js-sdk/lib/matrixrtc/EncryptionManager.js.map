{"version":3,"file":"EncryptionManager.js","names":["logger","rootLogger","secureRandomBase64Url","decodeBase64","encodeUnpaddedBase64","safeGetRetryAfterMs","KeyTransportEvents","isMyMembership","getEncryptionKeyMapKey","membership","concat","userId","deviceId","memberId","EncryptionManager","updateEncryptionKeyThrottle","_this$joinConfig$upda","_this$joinConfig","joinConfig","makeKeyDelay","_this$joinConfig$make","_this$joinConfig2","useKeyDelay","_this$joinConfig$useK","_this$joinConfig3","constructor","getMemberships","transport","statistics","onEncryptionKeysChanged","parentLogger","_this","_defineProperty","Set","Map","_ref","_asyncToGenerator","indexToSend","keysEventUpdateTimeout","undefined","clearTimeout","lastEncryptionKeyUpdateRequest","Date","now","joined","myKeys","getKeysForParticipant","warn","latestGeneratedKeyIndex","keyIndexToSend","info","keyToSend","counters","roomEventEncryptionKeysSent","targets","filter","sender","map","membershipTs","createdTs","sendKey","debug","length","error","resendDelay","setTimeout","sendEncryptionKeysEvent","_x","apply","arguments","keyBase64Encoded","index","timestamp","setEncryptionKey","manageMediaKeys","makeNewKeyTimeout","newKeyIndex","makeNewSenderKey","getChild","rtcBackendIdentityFromMembershipParts","getEncryptionKeys","keysMap","userKeyEntry","encryptionKeys","keys","entry","key","keyIndex","rtcBackendIdentity","set","join","_this$joinConfig$mana","_this$joinConfig4","_this$joinConfig5","on","ReceivedKeys","onNewKeyReceived","start","requestSendCurrentKey","leave","off","stop","t","setNewKeyTimeouts","clear","onMembershipsUpdate","oldMemberships","oldMembershipIds","m","newMembershipIds","anyLeft","Array","from","some","x","has","anyJoined","oldFingerprints","lastMembershipFingerprints","storeLastMembershipFingerprints","onRotateKeyTimeout","newFingerprints","candidateUpdates","delayBeforeUse","encryptionKey","encryptionKeyIndex","getNewEncryptionKeyIndex","_this$encryptionKeys$","get","encryptionKeyString","keyBin","mapKey","participantKeys","existingKeyAtIndex","keysEqual","useKeyTimeout","delete","add","a","b","every","i"],"sources":["../../src/matrixrtc/EncryptionManager.ts"],"sourcesContent":["import { type Logger, logger as rootLogger } from \"../logger.ts\";\nimport { type EncryptionConfig } from \"./MatrixRTCSession.ts\";\nimport { secureRandomBase64Url } from \"../randomstring.ts\";\nimport { decodeBase64, encodeUnpaddedBase64 } from \"../base64.ts\";\nimport { safeGetRetryAfterMs } from \"../http-api/errors.ts\";\nimport { type CallMembership } from \"./CallMembership.ts\";\nimport { type KeyTransportEventListener, KeyTransportEvents, type IKeyTransport } from \"./IKeyTransport.ts\";\nimport { isMyMembership, type EncryptionKeyMapKey, type Statistics } from \"./types.ts\";\n\n/**\n * The string used for the keys in the the encryption key map.\n * `@bob:examle.org:DEVICEID(UUIDRANDOM_MEMBERID_RANDOMUUID)`\n */\nexport function getEncryptionKeyMapKey(membership: CallMembershipIdentityParts): EncryptionKeyMapKey {\n    return `${membership.userId}:${membership.deviceId}(${membership.memberId})`;\n}\n\n/**\n * This interface is for testing and for making it possible to interchange the encryption manager.\n * @internal\n */\nexport interface IEncryptionManager {\n    /**\n     * Joins the encryption manager with the provided configuration.\n     *\n     * @param joinConfig - The configuration for joining encryption, or undefined\n     * if no specific configuration is provided.\n     */\n    join(joinConfig: EncryptionConfig | undefined): void;\n\n    /**\n     * Leaves the encryption manager, cleaning up any associated resources.\n     */\n    leave(): void;\n\n    /**\n     * Called from the MatrixRTCSession when the memberships in this session updated.\n     *\n     * @param oldMemberships - The previous state of call memberships before the update.\n     */\n    onMembershipsUpdate(oldMemberships: CallMembership[]): void;\n\n    /**\n     * Retrieves the encryption keys currently managed by the encryption manager.\n     *\n     * @returns A map of participant IDs to their encryption keys.\n     */\n    getEncryptionKeys(): ReadonlyMap<\n        EncryptionKeyMapKey,\n        ReadonlyArray<{\n            key: Uint8Array<ArrayBuffer>;\n            keyIndex: number;\n            membership: CallMembershipIdentityParts;\n            rtcBackendIdentity: string;\n        }>\n    >;\n}\n\nexport type CallMembershipIdentityParts = Pick<CallMembership, \"userId\" | \"deviceId\" | \"memberId\">;\n\n/**\n * This class implements the IEncryptionManager interface,\n * and takes care of managing the encryption keys of all rtc members:\n *  - generate new keys for the local user and send them to other participants\n *  - track all keys of all other members and update livekit.\n *\n * @internal\n */\nexport class EncryptionManager implements IEncryptionManager {\n    private manageMediaKeys = false;\n    private keysEventUpdateTimeout?: ReturnType<typeof setTimeout>;\n    private makeNewKeyTimeout?: ReturnType<typeof setTimeout>;\n    private setNewKeyTimeouts = new Set<ReturnType<typeof setTimeout>>();\n\n    private get updateEncryptionKeyThrottle(): number {\n        return this.joinConfig?.updateEncryptionKeyThrottle ?? 3_000;\n    }\n\n    private get makeKeyDelay(): number {\n        return this.joinConfig?.makeKeyDelay ?? 3_000;\n    }\n\n    private get useKeyDelay(): number {\n        return this.joinConfig?.useKeyDelay ?? 5_000;\n    }\n\n    private encryptionKeys = new Map<\n        string,\n        Array<{ key: Uint8Array<ArrayBuffer>; timestamp: number; membership: CallMembershipIdentityParts }>\n    >();\n    private lastEncryptionKeyUpdateRequest?: number;\n\n    // We use this to store the last membership fingerprints we saw, so we can proactively re-send encryption keys\n    // if it looks like a membership has been updated.\n    private lastMembershipFingerprints: Set<string> | undefined;\n\n    private latestGeneratedKeyIndex = -1;\n    private joinConfig: EncryptionConfig | undefined;\n    private logger: Logger;\n\n    public constructor(\n        private membership: CallMembershipIdentityParts,\n        private getMemberships: () => CallMembership[],\n        private transport: IKeyTransport,\n        private statistics: Statistics,\n        private onEncryptionKeysChanged: (\n            keyBin: Uint8Array<ArrayBuffer>,\n            encryptionKeyIndex: number,\n            membership: CallMembershipIdentityParts,\n            rtcBackendIdentity: string,\n        ) => void,\n        parentLogger?: Logger,\n    ) {\n        this.logger = (parentLogger ?? rootLogger).getChild(`[EncryptionManager]`);\n    }\n\n    private rtcBackendIdentityFromMembershipParts(membership: CallMembershipIdentityParts): string {\n        // Implement logic to construct rtcBackendIdentity from membership parts\n        return `${membership.userId}:${membership.deviceId}`;\n    }\n\n    public getEncryptionKeys(): ReadonlyMap<\n        EncryptionKeyMapKey,\n        ReadonlyArray<{\n            key: Uint8Array<ArrayBuffer>;\n            keyIndex: number;\n            membership: CallMembershipIdentityParts;\n            rtcBackendIdentity: string;\n        }>\n    > {\n        const keysMap = new Map<\n            EncryptionKeyMapKey,\n            ReadonlyArray<{\n                key: Uint8Array<ArrayBuffer>;\n                keyIndex: number;\n                membership: CallMembershipIdentityParts;\n                rtcBackendIdentity: string;\n            }>\n        >();\n        for (const [userId, userKeyEntry] of this.encryptionKeys) {\n            const keys = userKeyEntry.map((entry, index) => ({\n                key: entry.key,\n                membership: entry.membership,\n                keyIndex: index,\n                rtcBackendIdentity: this.rtcBackendIdentityFromMembershipParts(entry.membership),\n            }));\n            keysMap.set(userId as EncryptionKeyMapKey, keys);\n        }\n        return keysMap;\n    }\n\n    private joined = false;\n\n    public join(joinConfig: EncryptionConfig): void {\n        this.joinConfig = joinConfig;\n        this.joined = true;\n        this.manageMediaKeys = this.joinConfig?.manageMediaKeys ?? this.manageMediaKeys;\n\n        this.transport.on(KeyTransportEvents.ReceivedKeys, this.onNewKeyReceived);\n\n        this.transport.start();\n        if (this.joinConfig?.manageMediaKeys) {\n            this.makeNewSenderKey();\n            this.requestSendCurrentKey();\n        }\n    }\n\n    public leave(): void {\n        // clear our encryption keys as we're done with them now (we'll\n        // make new keys if we rejoin). We leave keys for other participants\n        // as they may still be using the same ones.\n        this.encryptionKeys.set(getEncryptionKeyMapKey(this.membership), []);\n        this.transport.off(KeyTransportEvents.ReceivedKeys, this.onNewKeyReceived);\n        this.transport.stop();\n\n        if (this.makeNewKeyTimeout !== undefined) {\n            clearTimeout(this.makeNewKeyTimeout);\n            this.makeNewKeyTimeout = undefined;\n        }\n        for (const t of this.setNewKeyTimeouts) {\n            clearTimeout(t);\n        }\n        this.setNewKeyTimeouts.clear();\n\n        this.manageMediaKeys = false;\n        this.joined = false;\n    }\n\n    public onMembershipsUpdate(oldMemberships: CallMembership[]): void {\n        if (this.manageMediaKeys && this.joined) {\n            const oldMembershipIds = new Set(\n                oldMemberships\n                    .filter((m) => !isMyMembership(m, this.membership.userId, this.membership.deviceId))\n                    .map(getEncryptionKeyMapKey),\n            );\n            const newMembershipIds = new Set(\n                this.getMemberships()\n                    .filter((m) => !isMyMembership(m, this.membership.userId, this.membership.deviceId))\n                    .map(getEncryptionKeyMapKey),\n            );\n\n            // We can use https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Set/symmetricDifference\n            // for this once available\n            const anyLeft = Array.from(oldMembershipIds).some((x) => !newMembershipIds.has(x));\n            const anyJoined = Array.from(newMembershipIds).some((x) => !oldMembershipIds.has(x));\n\n            const oldFingerprints = this.lastMembershipFingerprints;\n            // always store the fingerprints of these latest memberships\n            this.storeLastMembershipFingerprints();\n\n            if (anyLeft) {\n                if (this.makeNewKeyTimeout) {\n                    // existing rotation in progress, so let it complete\n                } else {\n                    this.logger.debug(`Member(s) have left: queueing sender key rotation`);\n                    this.makeNewKeyTimeout = setTimeout(this.onRotateKeyTimeout, this.makeKeyDelay);\n                }\n            } else if (anyJoined) {\n                this.logger.debug(`New member(s) have joined: re-sending keys`);\n                this.requestSendCurrentKey();\n            } else if (oldFingerprints) {\n                // does it look like any of the members have updated their memberships?\n                const newFingerprints = this.lastMembershipFingerprints!;\n\n                // We can use https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Set/symmetricDifference\n                // for this once available\n                const candidateUpdates =\n                    Array.from(oldFingerprints).some((x) => !newFingerprints.has(x)) ||\n                    Array.from(newFingerprints).some((x) => !oldFingerprints.has(x));\n                if (candidateUpdates) {\n                    this.logger.debug(`Member(s) have updated/reconnected: re-sending keys to everyone`);\n                    this.requestSendCurrentKey();\n                }\n            }\n        }\n    }\n\n    /**\n     * Generate a new sender key and add it at the next available index\n     * @param delayBeforeUse - If true, wait for a short period before setting the key for the\n     *                         media encryptor to use. If false, set the key immediately.\n     * @returns The index of the new key\n     */\n    private makeNewSenderKey(delayBeforeUse = false): number {\n        const encryptionKey = secureRandomBase64Url(16);\n        const encryptionKeyIndex = this.getNewEncryptionKeyIndex();\n        this.logger.info(\"Generated new key at index \" + encryptionKeyIndex);\n        this.setEncryptionKey(this.membership, encryptionKeyIndex, encryptionKey, Date.now(), delayBeforeUse);\n        return encryptionKeyIndex;\n    }\n\n    /**\n     * Requests that we resend our current keys to the room. May send a keys event immediately\n     * or queue for alter if one has already been sent recently.\n     */\n    private requestSendCurrentKey(): void {\n        if (!this.manageMediaKeys) return;\n\n        if (\n            this.lastEncryptionKeyUpdateRequest &&\n            this.lastEncryptionKeyUpdateRequest + this.updateEncryptionKeyThrottle > Date.now()\n        ) {\n            this.logger.info(\"Last encryption key event sent too recently: postponing\");\n            if (this.keysEventUpdateTimeout === undefined) {\n                this.keysEventUpdateTimeout = setTimeout(\n                    () => void this.sendEncryptionKeysEvent(),\n                    this.updateEncryptionKeyThrottle,\n                );\n            }\n            return;\n        }\n\n        void this.sendEncryptionKeysEvent();\n    }\n\n    /**\n     * Get the known encryption keys for a given participant device.\n     *\n     * @param membership - The membership identity parts of the participant\n     * @returns The encryption keys for the given participant, or undefined if they are not known.\n     */\n    private getKeysForParticipant(membership: CallMembershipIdentityParts): Array<Uint8Array<ArrayBuffer>> | undefined {\n        return this.encryptionKeys.get(getEncryptionKeyMapKey(membership))?.map((entry) => entry.key);\n    }\n\n    /**\n     * Re-sends the encryption keys room event\n     */\n    private sendEncryptionKeysEvent = async (indexToSend?: number): Promise<void> => {\n        if (this.keysEventUpdateTimeout !== undefined) {\n            clearTimeout(this.keysEventUpdateTimeout);\n            this.keysEventUpdateTimeout = undefined;\n        }\n        this.lastEncryptionKeyUpdateRequest = Date.now();\n\n        if (!this.joined) return;\n\n        const myKeys = this.getKeysForParticipant(this.membership);\n\n        if (!myKeys) {\n            this.logger.warn(\"Tried to send encryption keys event but no keys found!\");\n            return;\n        }\n\n        if (typeof indexToSend !== \"number\" && this.latestGeneratedKeyIndex === -1) {\n            this.logger.warn(\"Tried to send encryption keys event but no current key index found!\");\n            return;\n        }\n\n        const keyIndexToSend = indexToSend ?? this.latestGeneratedKeyIndex;\n\n        this.logger.info(\n            `Try sending encryption keys event. keyIndexToSend=${keyIndexToSend} (method parameter: ${indexToSend})`,\n        );\n        const keyToSend = myKeys[keyIndexToSend];\n\n        try {\n            this.statistics.counters.roomEventEncryptionKeysSent += 1;\n            const targets = this.getMemberships()\n                .filter((membership) => {\n                    return membership.sender != undefined;\n                })\n                .map((membership) => {\n                    return {\n                        userId: membership.sender!,\n                        deviceId: membership.deviceId,\n                        membershipTs: membership.createdTs(),\n                    };\n                });\n            await this.transport.sendKey(encodeUnpaddedBase64(keyToSend), keyIndexToSend, targets);\n            this.logger.debug(\n                `sendEncryptionKeysEvent participantId=${this.membership.userId}:${this.membership.deviceId} numKeys=${myKeys.length} currentKeyIndex=${this.latestGeneratedKeyIndex} keyIndexToSend=${keyIndexToSend}`,\n            );\n        } catch (error) {\n            if (this.keysEventUpdateTimeout === undefined) {\n                const resendDelay = safeGetRetryAfterMs(error, 5000);\n                this.logger.warn(`Failed to send m.call.encryption_key, retrying in ${resendDelay}`, error);\n                this.keysEventUpdateTimeout = setTimeout(() => void this.sendEncryptionKeysEvent(), resendDelay);\n            } else {\n                this.logger.info(\"Not scheduling key resend as another re-send is already pending\");\n            }\n        }\n    };\n\n    public onNewKeyReceived: KeyTransportEventListener = (membership, keyBase64Encoded, index, timestamp) => {\n        this.logger.debug(\n            `Received key over key transport ${membership.userId}:${membership.deviceId} at index ${index}`,\n        );\n        this.setEncryptionKey(membership, index, keyBase64Encoded, timestamp);\n    };\n\n    private storeLastMembershipFingerprints(): void {\n        this.lastMembershipFingerprints = new Set(\n            this.getMemberships()\n                .filter((m) => !isMyMembership(m, this.membership.userId, this.membership.deviceId))\n                .map((m) => `${getEncryptionKeyMapKey(m)}:${m.createdTs()}`),\n        );\n    }\n\n    private getNewEncryptionKeyIndex(): number {\n        if (this.latestGeneratedKeyIndex === -1) {\n            return 0;\n        }\n\n        // maximum key index is 255\n        return (this.latestGeneratedKeyIndex + 1) % 256;\n    }\n\n    /**\n     * Sets an encryption key at a specified index for a participant.\n     * The encryption keys for the local participant are also stored here under the\n     * user and device ID of the local participant.\n     * If the key is older than the existing key at the index, it will be ignored.\n     * @param userId - The user ID of the participant\n     * @param deviceId - Device ID of the participant\n     * @param encryptionKeyIndex - The index of the key to set\n     * @param encryptionKeyString - The string representation of the key to set in base64\n     * @param timestamp - The timestamp of the key. We assume that these are monotonic for each participant device.\n     * @param delayBeforeUse - If true, delay before emitting a key changed event. Useful when setting\n     *                         encryption keys for the local participant to allow time for the key to\n     *                         be distributed.\n     */\n    private setEncryptionKey(\n        membership: CallMembershipIdentityParts,\n        encryptionKeyIndex: number,\n        encryptionKeyString: string,\n        timestamp: number,\n        delayBeforeUse = false,\n    ): void {\n        this.logger.debug(\n            `Setting encryption key for ${membership.userId}:${membership.deviceId} at index ${encryptionKeyIndex}`,\n        );\n        const keyBin = decodeBase64(encryptionKeyString);\n\n        const mapKey = getEncryptionKeyMapKey(membership);\n        if (!this.encryptionKeys.has(mapKey)) {\n            this.encryptionKeys.set(mapKey, []);\n        }\n        const participantKeys = this.encryptionKeys.get(mapKey)!;\n\n        const existingKeyAtIndex = participantKeys[encryptionKeyIndex];\n\n        if (existingKeyAtIndex) {\n            if (existingKeyAtIndex.timestamp > timestamp) {\n                this.logger.info(\n                    `Ignoring new key at index ${encryptionKeyIndex} for ${mapKey} as it is older than existing known key`,\n                );\n                return;\n            }\n\n            if (keysEqual(existingKeyAtIndex.key, keyBin)) {\n                existingKeyAtIndex.timestamp = timestamp;\n                return;\n            }\n        }\n\n        if (membership.userId === this.membership.userId && membership.deviceId === this.membership.deviceId) {\n            // It is important to already update the latestGeneratedKeyIndex here\n            // NOT IN THE `delayBeforeUse` `setTimeout`.\n            // Even though this is where we call onEncryptionKeysChanged and set the key in EC (and livekit).\n            // It needs to happen here because we will send the key before the timeout has passed and sending\n            // the key will use latestGeneratedKeyIndex as the index. if we update it in the `setTimeout` callback\n            // it will use the wrong index (index - 1)!\n            this.latestGeneratedKeyIndex = encryptionKeyIndex;\n        }\n        participantKeys[encryptionKeyIndex] = {\n            key: keyBin,\n            timestamp,\n            membership: membership,\n        };\n\n        if (delayBeforeUse) {\n            const useKeyTimeout = setTimeout(() => {\n                this.setNewKeyTimeouts.delete(useKeyTimeout);\n                this.logger.info(`Delayed-emitting key changed event for ${mapKey} index ${encryptionKeyIndex}`);\n\n                this.onEncryptionKeysChanged(\n                    keyBin,\n                    encryptionKeyIndex,\n                    membership,\n                    this.rtcBackendIdentityFromMembershipParts(membership),\n                );\n            }, this.useKeyDelay);\n            this.setNewKeyTimeouts.add(useKeyTimeout);\n        } else {\n            this.onEncryptionKeysChanged(\n                keyBin,\n                encryptionKeyIndex,\n                membership,\n                this.rtcBackendIdentityFromMembershipParts(membership),\n            );\n        }\n    }\n\n    private onRotateKeyTimeout = (): void => {\n        if (!this.manageMediaKeys) return;\n\n        this.makeNewKeyTimeout = undefined;\n        this.logger.info(\"Making new sender key for key rotation\");\n        const newKeyIndex = this.makeNewSenderKey(true);\n        // send immediately: if we're about to start sending with a new key, it's\n        // important we get it out to others as soon as we can.\n        void this.sendEncryptionKeysEvent(newKeyIndex);\n    };\n}\n\nfunction keysEqual(a: Uint8Array | undefined, b: Uint8Array | undefined): boolean {\n    if (a === b) return true;\n    return !!a && !!b && a.length === b.length && a.every((x, i) => x === b[i]);\n}\n"],"mappings":"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","ignoreList":[]}