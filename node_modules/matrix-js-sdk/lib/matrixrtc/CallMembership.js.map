{"version":3,"file":"CallMembership.js","names":["MXID_PATTERN","deepCompare","slotDescriptionToId","slotIdToDescription","sha256","encodeUnpaddedBase64","DEFAULT_EXPIRE_DURATION","checkRtcMembershipData","data","errors","referenceUserId","_data$sticky_key","prefix","slot_id","push","split","length","member","user_id","test","device_id","id","application","type","includes","rtc_transports","undefined","Array","isArray","t","versions","every","v","sticky_key","msc4354_sticky_key","rel","event_id","rel_type","checkSessionsMembershipData","_data$focus_active","call_id","focus_active","foci_preferred","f","created_ts","scope","CallMembership","equal","a","b","membershipData","constructor","matrixEvent","rtcBackendIdentity","logger","_defineProperty","eventId","sender","ts","getId","getSender","getTs","Error","matrixEventData","getChild","concat","deviceId","computeRtcBackendIdentity","_asyncToGenerator","kind","computeRtcIdentityRaw","userId","memberId","membershipDataFromMatrixEvent","content","getContent","sessionErrors","rtcErrors","details","join","json","JSON","stringify","replaceAll","slotId","_this$logger2","compatibilityAdaptedId","_this$logger","info","callIntent","_this$logger3","intent","warn","slotDescription","applicationData","membershipID","_data$membershipID","createdTs","_data$created_ts","getAbsoluteExpiry","_data$expires","expires","getMsUntilExpiry","Date","now","isExpired","getTransport","oldestMembership","focus_selection","getFocusActive","transports"],"sources":["../../src/matrixrtc/CallMembership.ts"],"sourcesContent":["/*\nCopyright 2023 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { MXID_PATTERN } from \"../models/room-member.ts\";\nimport { deepCompare } from \"../utils.ts\";\nimport { type LivekitFocusSelection } from \"./LivekitTransport.ts\";\nimport { slotDescriptionToId, slotIdToDescription, type SlotDescription } from \"./MatrixRTCSession.ts\";\nimport type { RTCCallIntent, Transport } from \"./types.ts\";\nimport { type MatrixEvent, type IContent } from \"../models/event.ts\";\nimport { type RelationType } from \"../@types/event.ts\";\nimport { sha256 } from \"../digest.ts\";\nimport { encodeUnpaddedBase64 } from \"../base64.ts\";\nimport { type Logger } from \"../logger.ts\";\n\n/**\n * The default duration in milliseconds that a membership is considered valid for.\n * Ordinarily the client responsible for the session will update the membership before it expires.\n * We use this duration as the fallback case where stale sessions are present for some reason.\n */\nexport const DEFAULT_EXPIRE_DURATION = 1000 * 60 * 60 * 4;\n\ntype CallScope = \"m.room\" | \"m.user\";\ntype Member = {\n    user_id: string;\n    device_id: string;\n    /**\n     * The id used on the media backend.\n     * (With livekit this is the participant identity on the LK SFU)\n     * This can be a UUID but right now it is `${this.matrixEventData.sender}:${data.device_id}`.\n     */\n    id: string;\n};\n\nexport interface RtcMembershipData {\n    \"slot_id\": string;\n    \"member\": Member;\n    \"m.relates_to\"?: {\n        event_id: string;\n        rel_type: RelationType.Reference;\n    };\n    \"application\": {\n        type: string;\n        // other application specific keys\n        [key: string]: unknown;\n    };\n    \"rtc_transports\": Transport[];\n    \"versions\": string[];\n    \"msc4354_sticky_key\"?: string;\n    \"sticky_key\"?: string;\n}\n\nconst checkRtcMembershipData = (\n    data: IContent,\n    errors: string[],\n    referenceUserId: string,\n): data is RtcMembershipData => {\n    const prefix = \" - \";\n\n    // required fields\n    if (typeof data.slot_id !== \"string\") {\n        errors.push(prefix + \"slot_id must be string\");\n    } else {\n        if (data.slot_id.split(\"#\").length !== 2) errors.push(prefix + 'slot_id must include exactly one \"#\"');\n    }\n    if (typeof data.member !== \"object\" || data.member === null) {\n        errors.push(prefix + \"member must be an object\");\n    } else {\n        if (typeof data.member.user_id !== \"string\") errors.push(prefix + \"member.user_id must be string\");\n        else if (!MXID_PATTERN.test(data.member.user_id)) errors.push(prefix + \"member.user_id must be a valid mxid\");\n        // This is not what the spec enforces but there currently are no rules what power levels are required to\n        // send a m.rtc.member event for a other user. So we add this check for simplicity and to avoid possible attacks until there\n        // is a proper definition when this is allowed.\n        else if (data.member.user_id !== referenceUserId) errors.push(prefix + \"member.user_id must match the sender\");\n        if (typeof data.member.device_id !== \"string\") errors.push(prefix + \"member.device_id must be string\");\n        if (typeof data.member.id !== \"string\") errors.push(prefix + \"member.id must be string\");\n    }\n    if (typeof data.application !== \"object\" || data.application === null) {\n        errors.push(prefix + \"application must be an object\");\n    } else {\n        if (typeof data.application.type !== \"string\") {\n            errors.push(prefix + \"application.type must be a string\");\n        } else {\n            if (data.application.type.includes(\"#\")) errors.push(prefix + 'application.type must not include \"#\"');\n        }\n    }\n    if (data.rtc_transports === undefined || !Array.isArray(data.rtc_transports)) {\n        errors.push(prefix + \"rtc_transports must be an array\");\n    } else {\n        // validate that each transport has at least a string 'type'\n        for (const t of data.rtc_transports) {\n            if (typeof t !== \"object\" || t === null || typeof (t as any).type !== \"string\") {\n                errors.push(prefix + \"rtc_transports entries must be objects with a string type\");\n                break;\n            }\n        }\n    }\n    if (data.versions === undefined || !Array.isArray(data.versions)) {\n        errors.push(prefix + \"versions must be an array\");\n    } else if (!data.versions.every((v) => typeof v === \"string\")) {\n        errors.push(prefix + \"versions must be an array of strings\");\n    }\n\n    // optional fields\n    if ((data.sticky_key ?? data.msc4354_sticky_key) === undefined) {\n        errors.push(prefix + \"sticky_key or msc4354_sticky_key must be a defined\");\n    }\n    if (data.sticky_key !== undefined && typeof data.sticky_key !== \"string\") {\n        errors.push(prefix + \"sticky_key must be a string\");\n    }\n    if (data.msc4354_sticky_key !== undefined && typeof data.msc4354_sticky_key !== \"string\") {\n        errors.push(prefix + \"msc4354_sticky_key must be a string\");\n    }\n    if (\n        data.sticky_key !== undefined &&\n        data.msc4354_sticky_key !== undefined &&\n        data.sticky_key !== data.msc4354_sticky_key\n    ) {\n        errors.push(prefix + \"sticky_key and msc4354_sticky_key must be equal if both are defined\");\n    }\n    if (data[\"m.relates_to\"] !== undefined) {\n        const rel = data[\"m.relates_to\"] as RtcMembershipData[\"m.relates_to\"];\n        if (typeof rel !== \"object\" || rel === null) {\n            errors.push(prefix + \"m.relates_to must be an object if provided\");\n        } else {\n            if (typeof rel.event_id !== \"string\") errors.push(prefix + \"m.relates_to.event_id must be a string\");\n            if (rel.rel_type !== \"m.reference\") errors.push(prefix + \"m.relates_to.rel_type must be m.reference\");\n        }\n    }\n\n    return errors.length === 0;\n};\n\n/**\n * MSC4143 (MatrixRTC) session membership data.\n * Represents the `session` in the memberships section of an m.call.member event as it is on the wire.\n **/\nexport type SessionMembershipData = {\n    /**\n     * The RTC application defines the type of the RTC session.\n     */\n    \"application\": string;\n\n    /**\n     * The id of this session.\n     * A session can never span over multiple rooms so this id is to distinguish between\n     * multiple session in one room. A room wide session that is not associated with a user,\n     * and therefore immune to creation race conflicts, uses the `call_id: \"\"`.\n     */\n    \"call_id\": string;\n\n    /**\n     * The Matrix device ID of this session. A single user can have multiple sessions on different devices.\n     */\n    \"device_id\": string;\n\n    /**\n     * The focus selection system this user/membership is using.\n     */\n    \"focus_active\": LivekitFocusSelection;\n\n    /**\n     * A list of possible foci this user knows about. One of them might be used based on the focus_active\n     * selection system.\n     */\n    \"foci_preferred\": Transport[];\n\n    /**\n     * Optional field that contains the creation of the session. If it is undefined the creation\n     * is the `origin_server_ts` of the event itself. For updates to the event this property tracks\n     * the `origin_server_ts` of the initial join event.\n     *  - If it is undefined it can be interpreted as a \"Join\".\n     *  - If it is defined it can be interpreted as an \"Update\"\n     */\n    \"created_ts\"?: number;\n\n    // Application specific data\n\n    /**\n     * If the `application` = `\"m.call\"` this defines if it is a room or user owned call.\n     * There can always be one room scoped call but multiple user owned calls (breakout sessions)\n     */\n    \"scope\"?: CallScope;\n\n    /**\n     * Optionally we allow to define a delta to the `created_ts` that defines when the event is expired/invalid.\n     * This should be set to multiple hours. The only reason it exist is to deal with failed delayed events.\n     * (for example caused by a homeserver crashes)\n     **/\n    \"expires\"?: number;\n\n    /**\n     * The intent of the call from the perspective of this user. This may be an audio call, video call or\n     * something else.\n     */\n    \"m.call.intent\"?: RTCCallIntent;\n    /**\n     * The sticky key in case of a sticky event. This string encodes the application + device_id indicating the used slot + device.\n     */\n    \"msc4354_sticky_key\"?: string;\n\n    /**\n     * The id used on the media backend.\n     * (With livekit this is the participant identity on the LK SFU)\n     * This can be a UUID but right now it is `${this.matrixEventData.sender}:${data.device_id}`.\n     *\n     * It is compleatly valid to not set this field. Other clients will treat `undefined` as `${this.matrixEventData.sender}:${data.device_id}`\n     */\n    \"membershipID\"?: string;\n};\n\nconst checkSessionsMembershipData = (data: IContent, errors: string[]): data is SessionMembershipData => {\n    const prefix = \" - \";\n    if (typeof data.device_id !== \"string\") errors.push(prefix + \"device_id must be string\");\n    if (typeof data.call_id !== \"string\") errors.push(prefix + \"call_id must be string\");\n    if (typeof data.application !== \"string\") errors.push(prefix + \"application must be a string\");\n    if (typeof data.focus_active?.type !== \"string\") errors.push(prefix + \"focus_active.type must be a string\");\n    if (data.focus_active === undefined) {\n        errors.push(prefix + \"focus_active has an invalid type\");\n    }\n    if (\n        data.foci_preferred !== undefined &&\n        !(\n            Array.isArray(data.foci_preferred) &&\n            data.foci_preferred.every(\n                (f: Transport) => typeof f === \"object\" && f !== null && typeof f.type === \"string\",\n            )\n        )\n    ) {\n        errors.push(prefix + \"foci_preferred must be an array of transport objects\");\n    }\n    // optional parameters\n    if (data.created_ts !== undefined && typeof data.created_ts !== \"number\") {\n        errors.push(prefix + \"created_ts must be number\");\n    }\n\n    // application specific data (we first need to check if they exist)\n    if (data.scope !== undefined && typeof data.scope !== \"string\") errors.push(prefix + \"scope must be string\");\n\n    if (data[\"m.call.intent\"] !== undefined && typeof data[\"m.call.intent\"] !== \"string\") {\n        errors.push(prefix + \"m.call.intent must be a string\");\n    }\n\n    return errors.length === 0;\n};\n\ntype MembershipData = { kind: \"rtc\"; data: RtcMembershipData } | { kind: \"session\"; data: SessionMembershipData };\n// TODO: Rename to RtcMembership once we removed the legacy SessionMembership from this file.\nexport class CallMembership {\n    public static equal(a?: CallMembership, b?: CallMembership): boolean {\n        return deepCompare(a?.membershipData, b?.membershipData);\n    }\n\n    private logger?: Logger;\n    /** The parsed data from the Matrix event.\n     * To access checked eventId and sender from the matrixEvent.\n     * Class construction will fail if these values cannot get obtained. */\n    private readonly matrixEventData: { eventId: string; sender: string; ts: number };\n\n    public constructor(\n        /** The required parts of the Matrix event that this membership is based on */\n        matrixEvent: Pick<MatrixEvent, \"getId\" | \"getSender\" | \"getTs\">,\n\n        /**\n         * The type checked membership data {data: (content of the matrix event), kind: (type hint)}\n         *\n         */\n        private readonly membershipData: MembershipData,\n\n        /**\n         *\n         * Anonymized identity to use with the RTC backend.\n         *\n         * The rtcBackendIdentity is a hashed version of all the identity parts:\n         * `sha256(${this.userId}|${this.deviceId}|${this.memberId})`\n         *\n         * It is used to anonymize the identity of the user in the RTC backend.\n         */\n        public readonly rtcBackendIdentity: string,\n        /**\n         * The constructor will automatically create a properly tagged child logger instance.\n         */\n        logger?: Logger,\n    ) {\n        const [eventId, sender, ts] = [matrixEvent.getId(), matrixEvent.getSender(), matrixEvent.getTs()];\n        if (eventId === undefined) throw new Error(\"parentEvent is missing eventId field\");\n        if (sender === undefined) throw new Error(\"parentEvent is missing sender field\");\n\n        this.matrixEventData = { eventId, sender, ts };\n\n        this.logger = logger?.getChild(`[CallMembership ${sender}:${this.deviceId}]`);\n    }\n\n    /**\n     * sha256(`${this.userId}|${this.deviceId}|${this.memberId}`) for sticky events (kind = rtc)\n     * `${this.userId}:${this.deviceId}` for state events (kind = session)\n     */\n    public static async computeRtcBackendIdentity(\n        matrixEvent: Pick<MatrixEvent, \"getSender\">,\n        membershipData: MembershipData,\n    ): Promise<string> {\n        const { kind, data } = membershipData;\n        switch (kind) {\n            case \"rtc\": {\n                return CallMembership.computeRtcIdentityRaw(data.member.user_id, data.member.device_id, data.member.id);\n            }\n            case \"session\":\n                return `${matrixEvent.getSender()}:${data.device_id}`;\n        }\n    }\n\n    public static async computeRtcIdentityRaw(userId: string, deviceId: string, memberId: string): Promise<string> {\n        return encodeUnpaddedBase64(await sha256(`${userId}|${deviceId}|${memberId}`));\n    }\n\n    public static membershipDataFromMatrixEvent(matrixEvent: MatrixEvent): MembershipData {\n        const [eventId, sender, content] = [matrixEvent.getId(), matrixEvent.getSender(), matrixEvent.getContent()];\n\n        if (eventId === undefined) throw new Error(\"parentEvent is missing eventId field\");\n        if (sender === undefined) throw new Error(\"parentEvent is missing sender field\");\n\n        const sessionErrors: string[] = [];\n        const rtcErrors: string[] = [];\n        if (checkSessionsMembershipData(content, sessionErrors)) {\n            return { kind: \"session\", data: content };\n        } else if (checkRtcMembershipData(content, rtcErrors, sender)) {\n            return { kind: \"rtc\", data: content };\n        } else {\n            const details =\n                sessionErrors.length < rtcErrors.length\n                    ? `Does not match MSC4143 m.call.member:\\n${sessionErrors.join(\"\\n\")}\\n\\n`\n                    : `Does not match MSC4143 m.rtc.member:\\n${rtcErrors.join(\"\\n\")}\\n\\n`;\n            const json = \"\\nevent:\\n\" + JSON.stringify(content).replaceAll('\"', \"'\");\n            throw Error(`unknown CallMembership data.\\n` + details + json);\n        }\n    }\n\n    /** @deprecated use userId instead */\n    public get sender(): string {\n        return this.userId;\n    }\n    public get userId(): string {\n        const { kind, data } = this.membershipData;\n        switch (kind) {\n            case \"rtc\":\n                return data.member.user_id;\n            case \"session\":\n            default:\n                return this.matrixEventData.sender;\n        }\n    }\n\n    public get eventId(): string {\n        return this.matrixEventData.eventId;\n    }\n\n    /**\n     * The ID of the MatrixRTC slot that this membership belongs to (format `{application}#{id}`).\n     * This is computed in case SessionMembershipData is used.\n     */\n    public get slotId(): string {\n        const { kind, data } = this.membershipData;\n        if (data.application === \"m.call\") {\n            switch (kind) {\n                case \"rtc\":\n                    return data.slot_id;\n                case \"session\":\n                default: {\n                    const [application, id] = [this.application, data.call_id];\n\n                    // INFO_SLOT_ID_LEGACY_CASE  (search for all occurances of this INFO to get the full picture)\n                    // The spec got changed to use `\"ROOM\"` instead of `\"\"` empyt string for the implicit default call.\n                    // State events still are sent with `\"\"` however. To find other events that should end up in the same call,\n                    // we use the slotId.\n                    // Since the CallMembership is the public representation of a rtc.member event, we just pretend it is a\n                    // \"ROOM\" slotId/call_id.\n                    // This makes all the remote members work with just this simple trick.\n                    //\n                    // We of course now need to be careful when sending legacy events (state events)\n                    // They get a slotDescription containing \"ROOM\" since this is what we use starting at the time this comment\n                    // is commited.\n                    //\n                    // See the Other INFO_SLOT_ID_LEGACY_CASE comments to see where we revert back to \"\" just before sending the event.\n                    let compatibilityAdaptedId: string;\n                    if (id === \"\") {\n                        compatibilityAdaptedId = \"ROOM\";\n                        this.logger?.info(\"use slotId compat hack emptyString -> ROOM\");\n                    } else {\n                        compatibilityAdaptedId = id;\n                    }\n                    return slotDescriptionToId({\n                        application,\n                        id: compatibilityAdaptedId,\n                    });\n                }\n            }\n        }\n\n        this.logger?.info(\"NOT using slotId compat hack emptyString -> ROOM\");\n        // This is what the function should look like for any other application that did not\n        // go through a `\"\"`=> `\"ROOM\"` rename\n        switch (kind) {\n            case \"rtc\":\n                return data.slot_id;\n            case \"session\":\n            default: {\n                const [application, id] = [this.application, data.call_id];\n                return slotDescriptionToId({ application, id });\n            }\n        }\n    }\n\n    public get deviceId(): string {\n        const { kind, data } = this.membershipData;\n        switch (kind) {\n            case \"rtc\":\n                return data.member.device_id;\n            case \"session\":\n            default:\n                return data.device_id;\n        }\n    }\n\n    public get callIntent(): RTCCallIntent | undefined {\n        const { kind, data } = this.membershipData;\n        switch (kind) {\n            case \"rtc\": {\n                const intent = data.application[\"m.call.intent\"];\n                if (typeof intent === \"string\") {\n                    return intent;\n                }\n                this.logger?.warn(\"RTC membership has invalid m.call.intent\");\n                return undefined;\n            }\n            case \"session\":\n            default:\n                return data[\"m.call.intent\"];\n        }\n    }\n\n    /**\n     * Parsed `slot_id` (format `{application}#{id}`) into its components (application and id).\n     */\n    public get slotDescription(): SlotDescription {\n        return slotIdToDescription(this.slotId);\n    }\n\n    public get application(): string {\n        const { kind, data } = this.membershipData;\n        switch (kind) {\n            case \"rtc\":\n                return data.application.type;\n            case \"session\":\n            default:\n                return data.application;\n        }\n    }\n    public get applicationData(): { type: string; [key: string]: unknown } {\n        const { kind, data } = this.membershipData;\n        switch (kind) {\n            case \"rtc\":\n                return data.application;\n            case \"session\":\n            default:\n                return { \"type\": data.application, \"m.call.intent\": data[\"m.call.intent\"] };\n        }\n    }\n\n    /** @deprecated scope is not used and will be removed in future versions. replaced by application specific types.*/\n    public get scope(): CallScope | undefined {\n        const { kind, data } = this.membershipData;\n        switch (kind) {\n            case \"rtc\":\n                return undefined;\n            case \"session\":\n            default:\n                return data.scope;\n        }\n    }\n    /**\n     * @deprecated renamed to `memberId`\n     */\n    public get membershipID(): string {\n        return this.memberId;\n    }\n\n    /**\n     * This computes the membership ID for the membership.\n     * For the sticky event based rtcSessionData this is trivial it is `member.id`.\n     * This is not supposed to be used to identity on an rtc backend. This is just a nouance for\n     * a generated (sha256) anonymised identity. Only send `rtcBackendIdentity` to any rtc backend service.\n     *\n     * For the legacy sessionMemberEvents it is a bit more complex. Here we sometimes do not have this data\n     * in the event content and we expected the SFU and the client to use `${this.matrixEventData.sender}:${data.device_id}`.\n     *\n     * So if there is no membershipID we use the hard coded jwt id default (`${this.matrixEventData.sender}:${data.device_id}`)\n     * value (used until version 0.16.0)\n     *\n     * It is also possible for a session event to set a custom membershipID. in that case this will be used.\n     */\n    public get memberId(): string {\n        // the createdTs behaves equivalent to the membershipID.\n        // we only need the field for the legacy member events where we needed to update them\n        // synapse ignores sending state events if they have the same content.\n        const { kind, data } = this.membershipData;\n        switch (kind) {\n            case \"rtc\":\n                return data.member.id;\n            case \"session\":\n            default:\n                return (\n                    // best case we have a client already publishing the right custom membershipId\n                    data.membershipID ??\n                    // alternativly we use the hard coded jwt id defuatl value (used until version 0.16.0)\n                    `${this.matrixEventData.sender}:${data.device_id}`\n                );\n        }\n    }\n\n    public createdTs(): number {\n        const { kind, data } = this.membershipData;\n        switch (kind) {\n            case \"rtc\":\n                // TODO we need to read the referenced (relation) event if available to get the real created_ts\n                return this.matrixEventData.ts;\n            case \"session\":\n            default:\n                return data.created_ts ?? this.matrixEventData.ts;\n        }\n    }\n\n    /**\n     * Gets the absolute expiry timestamp of the membership.\n     * @returns The absolute expiry time of the membership as a unix timestamp in milliseconds or undefined if not applicable\n     */\n    public getAbsoluteExpiry(): number | undefined {\n        const { kind, data } = this.membershipData;\n        switch (kind) {\n            case \"rtc\":\n                return undefined;\n            case \"session\":\n            default:\n                // TODO: calculate this from the MatrixRTCSession join configuration directly\n                return this.createdTs() + (data.expires ?? DEFAULT_EXPIRE_DURATION);\n        }\n    }\n\n    /**\n     * @returns The number of milliseconds until the membership expires or undefined if applicable\n     */\n    public getMsUntilExpiry(): number | undefined {\n        const { kind } = this.membershipData;\n        switch (kind) {\n            case \"rtc\":\n                return undefined;\n            case \"session\":\n            default:\n                // Assume that local clock is sufficiently in sync with other clocks in the distributed system.\n                // We used to try and adjust for the local clock being skewed, but there are cases where this is not accurate.\n                // The current implementation allows for the local clock to be -infinity to +MatrixRTCSession.MEMBERSHIP_EXPIRY_TIME/2\n                return this.getAbsoluteExpiry()! - Date.now();\n        }\n    }\n\n    /**\n     * @returns true if the membership has expired, otherwise false\n     */\n    public isExpired(): boolean {\n        const { kind } = this.membershipData;\n        switch (kind) {\n            case \"rtc\":\n                return false;\n            case \"session\":\n            default:\n                return this.getMsUntilExpiry()! <= 0;\n        }\n    }\n\n    /**\n     * ## RTC Membership\n     * Gets the primary transport to use for this RTC membership (m.rtc.member).\n     * This will return the primary transport that is used by this call membership to publish their media.\n     * Directly relates to the `rtc_transports` field.\n     *\n     * ## Legacy session membership\n     * In case of a legacy session membership (m.call.member) this will return the selected transport where\n     * media is published. How this selection happens depends on the `focus_active` field of the session membership.\n     * If the `focus_selection` is `oldest_membership` this will return the transport of the oldest membership\n     * in the room (based on the `created_ts` field of the session membership).\n     * If the `focus_selection` is `multi_sfu` it will return the first transport of the `foci_preferred` list.\n     * (`multi_sfu` is equivalent to how `m.rtc.member` `rtc_transports` work).\n     * @param oldestMembership For backwards compatibility with session membership (legacy). Unused in case of RTC membership.\n     * Always required to make the consumer not care if it deals with RTC or session memberships.\n     * @returns The transport this membership uses to publish media or undefined if no transport is available.\n     */\n    public getTransport(oldestMembership: CallMembership): Transport | undefined {\n        const { kind, data } = this.membershipData;\n        switch (kind) {\n            case \"rtc\":\n                return data.rtc_transports[0];\n            case \"session\":\n                switch (data.focus_active.focus_selection) {\n                    case \"multi_sfu\":\n                        return data.foci_preferred[0];\n                    case \"oldest_membership\":\n                        if (CallMembership.equal(this, oldestMembership)) return data.foci_preferred[0];\n                        if (oldestMembership !== undefined) return oldestMembership.getTransport(oldestMembership);\n                        break;\n                }\n        }\n        return undefined;\n    }\n\n    /**\n     * The focus_active filed of the session membership (m.call.member).\n     * @deprecated focus_active is not used and will be removed in future versions.\n     */\n    public getFocusActive(): LivekitFocusSelection | undefined {\n        const { kind, data } = this.membershipData;\n        if (kind === \"session\") return data.focus_active;\n        return undefined;\n    }\n    /**\n     * The value of the `rtc_transports` field for RTC memberships (m.rtc.member).\n     * Or the value of the `foci_preferred` field for legacy session memberships (m.call.member).\n     */\n    public get transports(): Transport[] {\n        const { kind, data } = this.membershipData;\n        switch (kind) {\n            case \"rtc\":\n                return data.rtc_transports;\n            case \"session\":\n            default:\n                return data.foci_preferred;\n        }\n    }\n    public get kind(): MembershipData[\"kind\"] {\n        return this.membershipData.kind;\n    }\n}\n"],"mappings":"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","ignoreList":[]}